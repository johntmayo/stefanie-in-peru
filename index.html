<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peru Deep Dive ‚Äî click‚Äëthru experience</title>
  <style>
    :root{
      --bg:#0d1210;
      --panel: rgba(255,255,255,.05);
      --panel2: rgba(0,0,0,.18);
      --text:#e9f2ec;
      --muted:#b7c6bd;
      --faint:#7f8f86;
      --stroke: rgba(255,255,255,.12);
      --shadow: 0 16px 40px rgba(0,0,0,.45);
      --r: 18px;
      --max: 720px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(800px 600px at 10% -10%, rgba(123,214,164,.18), transparent 55%),
        radial-gradient(900px 600px at 110% 10%, rgba(255,184,107,.15), transparent 55%),
        radial-gradient(900px 600px at 50% 120%, rgba(123,214,164,.10), transparent 60%),
        var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow:hidden; /* app-like */
    }
    button, input, textarea { font: inherit; }
    a{ color: inherit; }

    .app{
      height:100%;
      display:flex;
      flex-direction:column;
    }

    /* Top bar */
    .topbar{
      padding: 12px 14px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      min-width: 0;
    }
    .logo{
      width:42px; height:42px; border-radius: 14px;
      background: linear-gradient(145deg, rgba(123,214,164,.22), rgba(255,184,107,.16)), rgba(255,255,255,.06);
      border:1px solid var(--stroke);
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .logo span{ font-size: 22px; }
    .titles{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .titles .name{
      font-size: 14px;
      letter-spacing:.2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin:0;
    }
    .titles .sub{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin:0;
    }
    .meta{
      display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap;
    }
    .pill{
      display:flex; gap:8px; align-items:center;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .pill strong{ color: var(--text); font-weight:700; }

    /* Progress */
    .progressWrap{ padding: 0 14px 10px; }
    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(123,214,164,.92), rgba(255,184,107,.85));
      border-radius:999px;
      transition: width .25s ease;
    }
    .progressRow{
      margin-top: 8px;
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      color: var(--muted);
      font-size: 12px;
    }
    .hint{ color: var(--faint); }

    /* Stage area */
    .stage{
      flex:1;
      display:grid;
      place-items:center;
      padding: 0 14px 14px;
    }
    .card{
      width: min(100%, var(--max));
      border-radius: var(--r);
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* ‚ÄúScene‚Äù header with optional image */
    .sceneMedia{
      position:relative;
      height: 180px;
      background:
        radial-gradient(70% 70% at 30% 25%, rgba(123,214,164,.20), transparent 60%),
        radial-gradient(70% 70% at 70% 75%, rgba(255,184,107,.16), transparent 60%),
        rgba(0,0,0,.14);
      border-bottom: 1px solid var(--stroke);
      display:grid;
      place-items:center;
      overflow:hidden;
    }
    .sceneMedia img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter: saturate(1.05) contrast(1.05);
    }
    .mediaOverlay{
      position:absolute; inset:0;
      background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.55));
      pointer-events:none;
    }
    .sceneTag{
      position:absolute;
      left: 12px;
      top: 12px;
      display:inline-flex; gap:8px; align-items:center;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      color: rgba(255,255,255,.92);
      font-size: 12px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(123,214,164,.92);
      box-shadow: 0 0 0 6px rgba(123,214,164,.12);
    }
    .emojiFallback{
      font-size: 34px;
      opacity: .9;
      text-shadow: 0 10px 22px rgba(0,0,0,.45);
      display:none;
    }

    /* Scene body */
    .sceneBody{
      padding: 14px 14px 12px;
      display:grid;
      gap:12px;
    }
    .sceneTitle{
      margin:0;
      font-size: 16px;
      letter-spacing:.2px;
      line-height: 1.2;
    }
    .sceneText{
      margin:0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }

    .chunks{
      display:grid;
      gap:10px;
    }
    .chunk{
      padding: 12px;
      border-radius: 16px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.14);
    }
    .chunkHead{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .chunkHead strong{
      font-size: 13px;
      letter-spacing:.15px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      padding: 6px 9px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
      cursor:pointer;
      flex:0 0 auto;
      min-height: 34px;
    }
    .chip:active{ transform: scale(.99); }
    .reveal{
      display:none;
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
    }
    .reveal.show{ display:block; }

    .termRow{
      display:flex; flex-wrap:wrap; gap:8px;
    }
    .termBtn{
      min-height: 36px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .termBtn[aria-expanded="true"]{
      background: rgba(123,214,164,.14);
      border-color: rgba(123,214,164,.35);
      color: var(--text);
    }
    .termDef{
      display:none;
      margin-top: 10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      line-height: 1.55;
      font-size: 13px;
    }
    .termDef.show{ display:block; }

    .prompt{
      padding: 12px;
      border-radius: 16px;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      line-height: 1.55;
      font-size: 13px;
    }
    .prompt strong{ color: var(--text); }

    /* Bottom nav */
    .nav{
      padding: 10px 14px 14px;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:center;
    }
    .navLeft, .navRight{ display:flex; gap:10px; align-items:center; }
    .btn{
      min-height: 44px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      background: rgba(255,184,107,.16);
      border-color: rgba(255,184,107,.35);
    }
    .btn.ghost{
      background: rgba(0,0,0,.12);
      color: var(--muted);
    }
    .btn[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }
    .k{
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: rgba(0,0,0,.14);
      color: var(--muted);
      font-size: 12px;
      user-select:none;
    }

    /* Help sheet */
    .sheetBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      padding: 14px;
      z-index: 50;
    }
    .sheetBack.show{ display:grid; place-items:end center; }
    .sheet{
      width: min(100%, var(--max));
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(20,26,22,.95);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sheetHead{
      padding: 12px 12px 10px;
      border-bottom: 1px solid var(--stroke);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sheetHead h3{ margin:0; font-size: 14px; letter-spacing:.2px; }
    .sheetBody{
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.55;
      display:grid;
      gap:10px;
    }
    .sheetBody ul{ margin:0; padding-left: 18px; display:grid; gap:6px; }
    .small{ color: var(--faint); font-size: 12px; line-height: 1.4; }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>üáµüá™</span></div>
        <div class="titles">
          <p class="name" id="courseName">Peru Deep Dive</p>
          <p class="sub" id="sceneSub">Scene 1 of 18</p>
        </div>
      </div>
      <div class="meta">
        <div class="pill">üß† <strong id="deepCount">0</strong>/<span id="deepTotal">18</span></div>
        <button class="btn ghost" id="btnHelp" style="min-height:40px;">How to use</button>
      </div>
    </div>

    <div class="progressWrap">
      <div class="bar" aria-label="Progress"><div id="barFill"></div></div>
      <div class="progressRow">
        <div><span id="chapterMini">Chapter: ‚Ä¶</span> <span class="hint">‚Ä¢ tap ‚ÄúMore‚Äù in each card</span></div>
        <div class="hint"><span class="k">‚Üê</span> <span class="k">‚Üí</span> or swipe</div>
      </div>
    </div>

    <main class="stage" aria-label="Scene">
      <div class="card" id="card">
        <div class="sceneMedia" id="sceneMedia">
          <img id="sceneImg" src="" alt="" style="display:none" />
          <div class="emojiFallback" id="emojiFallback" aria-hidden="true">üó∫Ô∏è</div>
          <div class="mediaOverlay" aria-hidden="true"></div>
          <div class="sceneTag"><span class="dot" id="sceneDot"></span><span id="sceneTagText">‚Ä¶</span></div>
        </div>

        <div class="sceneBody">
          <h2 class="sceneTitle" id="sceneTitle">‚Ä¶</h2>
          <p class="sceneText" id="sceneIntro">‚Ä¶</p>

          <div class="chunks" id="chunks"></div>

          <div class="prompt" id="promptBox" style="display:none;"></div>

          <div class="chunk" id="termsBox" style="display:none;">
            <div class="chunkHead">
              <strong>Key terms (tap to define)</strong>
              <span class="chip" id="termsHint">Tap</span>
            </div>
            <div class="termRow" id="termRow"></div>
            <div class="termDef" id="termDef"></div>
          </div>

          <div class="small" id="sourcesLine" style="display:none;"></div>
        </div>

        <div class="nav">
          <div class="navLeft">
            <button class="btn ghost" id="btnBack">Back</button>
            <button class="btn ghost" id="btnRestart">Restart</button>
          </div>
          <div class="navRight">
            <button class="btn" id="btnMark">Mark learned</button>
            <button class="btn primary" id="btnNext">Next</button>
          </div>
        </div>
      </div>
    </main>

    <!-- Help sheet -->
    <div class="sheetBack" id="sheetBack" role="dialog" aria-modal="true" aria-label="How to use">
      <div class="sheet">
        <div class="sheetHead">
          <h3>How this works</h3>
          <button class="btn ghost" id="btnCloseSheet" style="min-height:40px;">Close</button>
        </div>
        <div class="sheetBody">
          <p>This is a click‚Äëthru ‚Äúfield guide.‚Äù Each scene is a mini‚Äëlesson with depth.</p>
          <ul>
            <li>Tap <strong>More</strong> inside each card to reveal the deeper explanation.</li>
            <li>Tap <strong>Key terms</strong> pills for definitions.</li>
            <li>Tap <strong>Mark learned</strong> to keep track of what you actually absorbed (saved locally).</li>
            <li>Use <strong>Next</strong>, arrow keys, or swipe.</li>
          </ul>
          <p class="small">Optional images: place up to 6 images in <code>images/</code> (filenames listed inside the file). If missing, the app shows emoji placeholders.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----- Teaching concept: ‚ÄúGuided journey‚Äù
    // Linear scenes (like walking through Peru west‚Üíeast and past‚Üípresent),
    // each scene has: a hook + 2‚Äì3 ‚Äúcards‚Äù (tap to reveal deeper text) + optional prompt + key terms.

    const LS_KEY = "peru_clickthru_v1";

    const SOURCES = {
      machu: { label:"UNESCO: Historic Sanctuary of Machu Picchu", href:"https://whc.unesco.org/en/list/274/" },
      nazca: { label:"UNESCO: Lines and Geoglyphs of Nasca and Palpa", href:"https://whc.unesco.org/en/list/700/" },
      indep: { label:"Britannica: Achievement of independence (Peru)", href:"https://www.britannica.com/place/Peru/Achievement-of-independence" },
      geo:   { label:"Geography (Costa/Sierra/Selva)", href:"https://en.wikipedia.org/wiki/Geography_of_Peru" }
    };

    // Up to 6 optional images (as requested)
    // Put your files in /images/ with these names, or change paths here:
    const IMAGES = {
      machu: "images/machu-picchu.jpg",
      andes: "images/andes.jpg",
      amazon:"images/amazon.jpg",
      lima:  "images/lima.jpg",
      nazca: "images/nazca.jpg",
      ceviche:"images/ceviche.jpg"
    };

    // Scenes: 18 total (6 chapters √ó 3 scenes). Each scene: title, intro, chunks (tap-to-reveal), prompt, terms, sources, media.
    const SCENES = [
      // Chapter 1: The Map
      mkScene("Map","üó∫Ô∏è","rgba(123,214,164,.92)","geo",null,
        "Peru makes more sense when you stop thinking ‚Äúnorth‚Äìsouth‚Äù and start thinking ‚Äúwest‚Äìeast.‚Äù",
        "Three words unlock the country: Costa (coast), Sierra (Andes), Selva (Amazon). It‚Äôs simplified, but it predicts climate, food, languages, and how hard it is to get somewhere.",
        [
          chunk("The big idea","Tap More","Costa/Sierra/Selva isn‚Äôt trivia. It‚Äôs a mental model. If you know which zone you‚Äôre in, you can infer: temperature swings, typical crops, transport options, and even what the daily rhythm feels like."),
          chunk("Why it matters","Tap More","A traveler mistake is thinking Peru is one climate. It isn‚Äôt. You can be near the equator and still be cold at night. You can be on the coast and still be in a desert."),
          chunk("Quick test","Tap More","If a town is in the Sierra: expect altitude, cold nights, steep roads, terrace farming. If it‚Äôs in the Selva: expect heat, humidity, rivers as infrastructure.")
        ],
        "Connect the dots: Pick one place you‚Äôve heard of (Lima, Cusco, Iquitos). Which zone is it in‚Äîand what does that predict about daily life?",
        [
          term("Costa","Coastal plain along the Pacific. Often arid; green clusters around river valleys."),
          term("Sierra","The Andes highlands: altitude, cold nights, steep terrain, big microclimates."),
          term("Selva","Amazon basin side: heat, humidity, river networks, high biodiversity."),
          term("Altitude","Less oxygen per breath; affects sleep, stamina, and hydration needs.")
        ],
        [SOURCES.geo]
      ),
      mkScene("Map","üåä","rgba(255,184,107,.86)","geo",null,
        "Coast surprise: Peru‚Äôs Pacific edge can feel like a desert.",
        "People expect tropical beaches. Instead, large parts of coastal Peru are dry. Cities and farms often cluster where water is predictable (rivers, aquifers, irrigated valleys).",
        [
          chunk("Why the coast can be dry","More","Cold ocean conditions can keep air cool and stable, and the Andes block many weather systems from the east. Result: long arid stretches, punctuated by green river valleys."),
          chunk("What you notice in real life","More","Green doesn‚Äôt always mean rain; it can mean irrigation. You‚Äôll see dense city life next to empty tan hills‚Äîbecause water access drives settlement."),
          chunk("What this teaches","More","Geography isn‚Äôt backdrop; it‚Äôs cause. It shapes where people live, what they eat, and what infrastructure becomes politically urgent (especially water).")
        ],
        null,
        [
          term("River valley","A narrow green corridor cutting through arid land‚Äîoften where farms and towns concentrate."),
          term("Irrigation","Moving water to fields; on the coast this can be the difference between desert and agriculture.")
        ],
        [SOURCES.geo]
      ),
      mkScene("Map","‚õ∞Ô∏è","rgba(123,214,164,.8)","geo","andes",
        "The Andes: a wall, and a ladder.",
        "Mountains block movement (a wall)‚Ä¶ but elevation creates stacked ecological zones (a ladder). People historically used different altitudes like a portfolio: potatoes up high, maize lower, tropical goods in foothills.",
        [
          chunk("Vertical geography","More","In the Andes, short horizontal distances can cross huge altitude changes. That means different crops, temperatures, and even building styles within a small area."),
          chunk("Time works differently","More","Two places that look close on a map may take hours to reach. Curves, passes, and altitude change the math. This is a big reason regions can keep distinct identities."),
          chunk("Empire logic","More","If you‚Äôre building a state here, you obsess over roads, storage, and communication. The Inca are famous partly because they built systems that match the mountains.")
        ],
        "Connect the dots: Imagine you‚Äôre moving goods from coast ‚Üí highlands. What breaks first: roads, bodies, or supply chain?",
        [
          term("Terraces","Stepped farmland that makes slopes productive and controls erosion/water."),
          term("Microclimate","Local climate shaped by terrain; mountains create many."),
          term("Pass","A navigable route through mountains; control passes and you control movement.")
        ],
        [SOURCES.geo]
      ),

      // Chapter 2: Lima + Coast
      mkScene("Lima & Coast","üèôÔ∏è","rgba(255,184,107,.9)","lima","lima",
        "Lima: a massive city on the edge of a desert.",
        "Lima is the capital and the biggest urban magnet. To understand it, don‚Äôt start with ‚Äúcity facts.‚Äù Start with the coast‚Äôs logic: ports, trade, and water constraints.",
        [
          chunk("Why Lima is where it is","More","Coastal capitals tend to sit where trade routes converge and where water can support dense settlement. On the Peruvian coast, rivers and engineered water systems matter‚Äîa lot."),
          chunk("What ‚Äòcapital‚Äô does","More","Capitals pull people, money, and culture inward. Lima becomes a mixing engine: migration from different regions means the city contains many Perus at once."),
          chunk("The traveler lesson","More","If you want to learn quickly, visit a market: you‚Äôll literally see the coast‚Äìhighlands‚Äìjungle supply chain on tables.")
        ],
        null,
        [
          term("Port city","A city tied to shipping/trade. Ports shape economy, migration, and food."),
          term("Migration","Movement of people; in Peru it strongly affects urban culture and cuisine.")
        ],
        [SOURCES.geo]
      ),
      mkScene("Lima & Coast","üçã","rgba(123,214,164,.85)","lima","ceviche",
        "Peruvian food is a geography lesson you can eat.",
        "The reason Peru‚Äôs cuisine feels ‚Äòbig‚Äô is because the country is ecologically big: a productive ocean, altitude zones, and an Amazon pantry‚Äîthen a major city that blends it all.",
        [
          chunk("Ceviche = Pacific logic","More","Ceviche is iconic because the coast is iconic. It‚Äôs not just a dish; it‚Äôs a statement that the sea is central to daily life and national identity."),
          chunk("Potatoes = Andes logic","More","Highland diversity and resilience show up in potatoes: many varieties, and preservation traditions like chu√±o (freeze-dried potatoes)."),
          chunk("Amazon ingredients = river/forest logic","More","Fruits, herbs, and local staples track rainforest ecology and river transport. Menus can be maps if you read them that way.")
        ],
        "Connect the dots: When you see a dish, ask: which region supplied the main ingredient, and what environment made it possible?",
        [
          term("Ceviche","Raw fish ‚Äòcooked‚Äô in citrus; a coastal emblem."),
          term("Chu√±o","Freeze-dried potato method: storage technology for highlands."),
          term("Biodiversity","Variety of life; shows up directly in ingredients.")
        ],
        [SOURCES.geo]
      ),
      mkScene("Lima & Coast","üåÄ","rgba(255,184,107,.8)","nazca","nazca",
        "Nazca: giant desert drawings from deep time.",
        "The Lines and Geoglyphs of Nasca and Palpa sit on Peru‚Äôs arid coastal plain, far south of Lima. They‚Äôre famous because they‚Äôre enormous‚Äîand because we still debate their full meaning.",
        [
          chunk("What they are (mechanically)","More","They were made by clearing or scratching the surface stones to reveal lighter ground beneath. Some lines run for kilometers; figures depict animals, stylized plants, and imaginary beings."),
          chunk("Why they survived","More","The desert helps preserve them. But ‚Äúpreserved‚Äù doesn‚Äôt mean ‚Äúsafe‚Äù‚Äîthey‚Äôre fragile, and modern impacts can damage them."),
          chunk("The real teaching point","More","Nazca is a reminder: Peru isn‚Äôt just ‚ÄòInca + Spanish.‚Äô There are many deep cultural layers‚Äîdifferent regions, different timelines.")
        ],
        null,
        [
          term("Geoglyph","A large ground figure made by arranging or removing surface material."),
          term("500 BCE‚Äì500 CE","UNESCO‚Äôs broad date range for the Nasca/Palpa geoglyph tradition.")
        ],
        [SOURCES.nazca]
      ),

      // Chapter 3: Andes + Inca
      mkScene("Andes","ü´Å","rgba(123,214,164,.9)","andes", "andes",
        "Altitude is physics (not vibes).",
        "At higher altitude, each breath delivers less oxygen. That changes sleep, stamina, and how fast you feel tired. People acclimate over time‚Äîso pacing is part of understanding the Andes.",
        [
          chunk("What altitude does to you","More","Lower oxygen pressure can mean headaches and poor sleep at first. It also changes your performance: stairs hit harder, dehydration sneaks up, and alcohol can feel stronger."),
          chunk("Why locals move differently","More","A slower pace isn‚Äôt laziness. It‚Äôs adaptation. Bodies and routines sync to altitude and temperature swings."),
          chunk("Travel strategy (not medical advice)","More","Day one: take it easy, hydrate, and keep meals simple. Let your body catch up before you try to ‚Äòcrush it.‚Äô")
        ],
        "Connect the dots: How would altitude change how an empire moves messengers, armies, and food?",
        [
          term("Acclimatization","The body adapting over time to altitude."),
          term("Microclimate","Temperature/weather can change dramatically with elevation and terrain.")
        ],
        [SOURCES.geo]
      ),
      mkScene("Andes","ü•î","rgba(255,184,107,.78)","andes", null,
        "Potatoes: a civilization technology.",
        "Potatoes were domesticated in the region of southern Peru/northwestern Bolivia. In highlands, diversity is risk management: different varieties handle different conditions.",
        [
          chunk("Diversity as resilience","More","If climate or pests hit one variety, another might still thrive. That‚Äôs a stability strategy built into agriculture."),
          chunk("Preservation changes everything","More","Techniques like chu√±o turn harvest into long-lasting stores. Storage is power: it stabilizes communities through lean seasons and shocks."),
          chunk("Why you should care","More","This is how you learn a place deeply: not ‚Äòwhat do they eat‚Äô but ‚Äòwhat problem does this food system solve?‚Äô")
        ],
        null,
        [
          term("Domestication","Humans shaping plants/animals over time for reliable use."),
          term("Chu√±o","Freeze-dried potato method; long-term storage in the Andes.")
        ],
        [SOURCES.geo]
      ),
      mkScene("Andes","üèõÔ∏è","rgba(123,214,164,.75)","machu","machu",
        "Machu Picchu is a whole sanctuary, not just a ruin.",
        "UNESCO recognizes Machu Picchu as a mixed World Heritage property (cultural + natural): monumental Inca architecture embedded in a protected mountain landscape.",
        [
          chunk("Why the setting matters","More","The drama isn‚Äôt only the stonework. It‚Äôs the placement: steep terrain, cloud-forest edges, and a built environment that handles water and slope."),
          chunk("Engineering mindset","More","Inca building is about fit: stone, gravity, drainage, and movement. It‚Äôs architecture that assumes earthquakes and mountains are normal."),
          chunk("Modern reality","More","Conservation is part of the story now: tourism pressure, erosion, and ecosystem protection are active challenges.")
        ],
        null,
        [
          term("Mixed World Heritage","UNESCO category for sites with both cultural and natural significance."),
          term("Sanctuary","Protected region; the landscape is part of what‚Äôs being preserved.")
        ],
        [SOURCES.machu]
      ),

      // Chapter 4: Amazonia
      mkScene("Amazonia","üö§","rgba(255,184,107,.85)","amazon","amazon",
        "In the jungle, rivers are the highways.",
        "In many Amazonian areas, rivers connect towns, move goods, and define where people settle. River levels change routes and travel times.",
        [
          chunk("Infrastructure without asphalt","More","Where roads are limited, water routes become the network. Schedules and logistics can hinge on rainfall and river height."),
          chunk("A different map","More","In the Andes you think passes. In the Amazon you think tributaries. That mental switch is a real ‚Äòaha‚Äô for understanding Peru."),
          chunk("What you notice traveling","More","You‚Äôll see towns oriented toward the river: docks, markets, transport‚Äîbecause the river is the main corridor.")
        ],
        "Connect the dots: If your ‚Äòhighway‚Äô changes seasonally, how does that change healthcare, schooling, and trade?",
        [
          term("Tributary","A smaller river feeding a larger one‚Äîkey in Amazon networks."),
          term("Wet/dry cycle","Seasonal shifts in rain and river levels affecting access.")
        ],
        [SOURCES.geo]
      ),
      mkScene("Amazonia","üå´Ô∏è","rgba(123,214,164,.75)","amazon", null,
        "The Andes‚ÄìAmazon edge: cloud forests and microclimates.",
        "Where the Andes descend into the Amazon basin you get lush transition zones‚Äîoften described as cloud forest‚Äîwith rapid changes in weather over short distances.",
        [
          chunk("Why ‚Äòedges‚Äô are rich","More","Ecological edges can concentrate biodiversity because species from multiple zones overlap. Topography creates pockets of distinct conditions."),
          chunk("Travel implication","More","You can go from cool to humid fast. Layers matter. This is Peru‚Äôs geography in miniature: vertical shifts create different worlds."),
          chunk("Teaching point","More","Biodiversity isn‚Äôt random; it‚Äôs structured by terrain and climate gradients.")
        ],
        null,
        [
          term("Cloud forest","Moist, misty transitional forests at mid-elevations."),
          term("Biodiversity","Variety of species; often extremely high in Amazon-related ecosystems.")
        ],
        [SOURCES.geo]
      ),
      mkScene("Amazonia","üî•","rgba(255,184,107,.7)","amazon", null,
        "Different constraints than the Andes: heat and humidity.",
        "In Amazonia, the hard part is often heat management, hydration, and insects‚Äînot altitude. Slow pacing is skill, not weakness.",
        [
          chunk("The body lesson","More","Heat makes everything harder: walking, thinking, carrying. Planning around shade and water is practical intelligence."),
          chunk("The ecosystem lesson","More","You‚Äôre in a dense living system. The goal is to experience it without damaging it: stick to trails, minimize waste, respect habitats."),
          chunk("How to learn deep","More","Ask what the environment demands from people: clothing, transport, housing, daily schedules. That‚Äôs culture shaped by ecology.")
        ],
        null,
        [
          term("Humidity","Water vapor in the air; affects comfort and hydration."),
          term("Leave No Trace","A set of practices for minimizing impact in natural areas.")
        ],
        [SOURCES.geo]
      ),

      // Chapter 5: History layers
      mkScene("History layers","‚è≥","rgba(123,214,164,.8)","history", null,
        "Peru is a layer cake, not a straight line.",
        "A useful way to learn: don‚Äôt flatten history into one story. Think in layers: pre‚ÄëInca cultures (vary by region), Inca systems, colonial rule, and modern republic.",
        [
          chunk("Why layers teach better","More","Layers keep you from calling everything ‚Äòancient.‚Äô They force you to ask: which group made this, when, and why here?"),
          chunk("Region matters","More","Different areas have different timelines. Nazca is coastal desert history; Inca is highland imperial history; Amazon histories have their own distinct patterns."),
          chunk("Your new habit","More","Whenever you‚Äôre somewhere: ask ‚Äòwhat‚Äôs the oldest layer here?‚Äô Then ‚Äòwhat‚Äôs the newest layer?‚Äô That‚Äôs instant depth.")
        ],
        "Connect the dots: How would Peru feel different if it had only one ‚Äòfoundational‚Äô civilization instead of many?",
        [
          term("Pre‚ÄëInca","Cultures that existed before the Inca period; many across Peru."),
          term("Colonial","Period of Spanish rule shaping cities, economy, and society.")
        ],
        [SOURCES.geo]
      ),
      mkScene("History layers","üìú","rgba(255,184,107,.78)","history", null,
        "Independence: a date and a process.",
        "Peru‚Äôs independence was declared on July 28, 1821. But the political‚Äëmilitary reality took longer; key conflict continued until 1824.",
        [
          chunk("Why declarations aren‚Äôt the whole story","More","A declaration is a symbolic break. But if opposing forces still control territory, independence is incomplete in practice."),
          chunk("Why Peru‚Äôs path was hard","More","Britannica notes that even after the 1821 declaration, Spanish forces remained strong in the interior until later victories helped secure independence."),
          chunk("Teaching point","More","National holidays commemorate symbols. Understanding the process gives you a more honest sense of how states are born.")
        ],
        null,
        [
          term("July 28, 1821","Independence declared in Lima; a core national commemorative date."),
          term("1824","Year of decisive events that helped ensure independence.")
        ],
        [SOURCES.indep]
      ),
      mkScene("History layers","üåÄ","rgba(123,214,164,.7)","nazca","nazca",
        "Nazca again ‚Äî because it rewires your timeline.",
        "It‚Äôs worth repeating: UNESCO dates the Nasca/Palpa geoglyph tradition roughly 500 BCE‚Äì500 CE. That‚Äôs centuries of continuity long before the Inca.",
        [
          chunk("What that implies","More","Long‚Äëduration projects suggest social organization: shared meaning, repeated practice, knowledge transmission. Whether ritual, processional paths, or something else‚Äîthis was not casual doodling."),
          chunk("How to visit it mentally","More","Instead of hunting one ‚Äòanswer,‚Äô notice: scale, materials, landscape, and what kind of society could maintain this tradition."),
          chunk("Your learning upgrade","More","When you see ‚Äòmystery site,‚Äô ask: what does it reveal about labor, coordination, and belief?")
        ],
        null,
        [
          term("Continuity","A practice repeated over long time spans; implies stable cultural transmission."),
          term("Landscape-scale art","Art made at the scale of terrain, meant to be experienced across space.")
        ],
        [SOURCES.nazca]
      ),

      // Chapter 6: People & culture
      mkScene("People & culture","üó£Ô∏è","rgba(255,184,107,.85)","culture", null,
        "Language is geography you can hear.",
        "Spanish is dominant nationally, and Quechua and Aymara (among others) are deeply tied to region and identity. Even if you only speak Spanish, noticing indigenous language presence changes how you read place names and signs.",
        [
          chunk("Why it matters","More","Language is a map of history: migration, state policy, and local identity show up in what people speak at home vs in public."),
          chunk("A respectful traveler move","More","You don‚Äôt need to perform. You can ask, listen, and learn a couple useful phrases when appropriate. Curiosity without spectacle is the vibe."),
          chunk("Teaching point","More","The ‚Äòsame country‚Äô can have different linguistic realities region to region. That‚Äôs a major part of Peru‚Äôs cultural depth.")
        ],
        "Connect the dots: How would your sense of ‚Äòhome‚Äô change if your public language and family language differed?",
        [
          term("Quechua","A family of indigenous languages widely associated with the Andes."),
          term("Aymara","An indigenous language especially associated with the southern highlands near Lake Titicaca.")
        ],
        []
      ),
      mkScene("People & culture","üõí","rgba(123,214,164,.78)","culture", null,
        "Markets are the fastest teacher.",
        "If you want speed‚Äëlearning, go to a market. You‚Äôll see ingredients, textiles, daily tools, and regional specialties in one place‚Äîplus the social rhythm of bargaining, chatting, and eating.",
        [
          chunk("What to look for","More","Ask where an ingredient came from: coast, highlands, jungle. That single question turns shopping into geography."),
          chunk("Why markets are cultural hubs","More","Markets are not just ‚Äòcommerce.‚Äô They‚Äôre where daily life happens: gossip, food, medicine herbs, seasonal shifts, celebrations."),
          chunk("Your one‚Äëquestion method","More","Pick one stall and ask: where is this from, who buys it, and what‚Äôs it used for? That‚Äôs depth in 3 minutes.")
        ],
        null,
        [
          term("Supply chain","How goods move from origin to consumer‚Äîmarkets expose it."),
          term("Seasonality","What‚Äôs available changes with weather and harvest cycles.")
        ],
        []
      ),
      mkScene("People & culture","üß≠","rgba(255,184,107,.7)","culture", null,
        "How to learn deep in-country (without being weird).",
        "One anchor topic per day. Investigate it: origin, function, meaning. This turns your trip into an intentional learning loop.",
        [
          chunk("Anchor topic examples","More","A textile pattern. A potato variety. A river transport route. A ceviche style. A festival dance. One thing‚Äîdeep."),
          chunk("Your three questions","More","1) Where did it come from? 2) What problem does it solve? 3) What does it mean to locals?"),
          chunk("Why this works","More","It keeps you from collecting trivia. You‚Äôre building mental models‚Äîhow environment, history, and culture co-produce daily life.")
        ],
        "Final prompt: What‚Äôs your first anchor topic going to be if you land in Peru tomorrow?",
        [
          term("Mental model","A simple structure that helps you predict how a system behaves."),
          term("Context","The surrounding conditions that give something its meaning (place, history, need).")
        ],
        []
      )
    ];

    function mkScene(chapter, emoji, dot, srcKey, mediaKey, title, intro, chunks, prompt, terms, sources){
      return { chapter, emoji, dot, srcKey, mediaKey, title, intro, chunks, prompt, terms, sources };
    }
    function chunk(head, cta, revealText){
      return { head, cta, revealText };
    }
    function term(t, d){ return { t, d }; }

    const state = {
      idx: 0,
      learned: {}, // idx -> true
    };

    const $ = s => document.querySelector(s);

    function load(){
      try{
        const saved = JSON.parse(localStorage.getItem(LS_KEY));
        if(saved && typeof saved === "object"){
          state.idx = clamp(saved.idx ?? 0, 0, SCENES.length-1);
          state.learned = saved.learned || {};
        }
      }catch(e){}
      $("#deepTotal").textContent = String(SCENES.length);
    }
    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }
    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
    function esc(s){
      return String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function render(){
      const scene = SCENES[state.idx];

      // Top meta
      $("#sceneSub").textContent = `Scene ${state.idx+1} of ${SCENES.length}`;
      $("#chapterMini").textContent = `Chapter: ${scene.chapter}`;

      // Progress
      const pct = Math.round(((state.idx) / (SCENES.length-1)) * 100);
      $("#barFill").style.width = pct + "%";

      // Tag
      $("#sceneTagText").textContent = scene.chapter;
      const dot = $("#sceneDot");
      dot.style.background = scene.dot || "rgba(123,214,164,.92)";
      dot.style.boxShadow = scene.dot?.includes("255,184,107") ? "0 0 0 6px rgba(255,184,107,.12)" : "0 0 0 6px rgba(123,214,164,.12)";

      // Media
      const imgEl = $("#sceneImg");
      const fallback = $("#emojiFallback");
      fallback.textContent = scene.emoji || "üáµüá™";
      const mediaSrc = scene.mediaKey ? IMAGES[scene.mediaKey] : null;

      if(mediaSrc){
        imgEl.src = mediaSrc;
        imgEl.alt = scene.mediaKey + " image";
        imgEl.style.display = "block";
        fallback.style.display = "none";
        // if missing, onerror will switch:
        imgEl.onerror = () => {
          imgEl.style.display = "none";
          fallback.style.display = "block";
        };
      }else{
        imgEl.style.display = "none";
        fallback.style.display = "block";
      }

      // Title + intro
      $("#sceneTitle").textContent = scene.title;
      $("#sceneIntro").textContent = scene.intro;

      // Chunks
      const chunksEl = $("#chunks");
      chunksEl.innerHTML = "";
      scene.chunks.forEach((c, i) => {
        const div = document.createElement("div");
        div.className = "chunk";
        div.innerHTML = `
          <div class="chunkHead">
            <strong>${esc(c.head)}</strong>
            <span class="chip" data-i="${i}" aria-expanded="false">${esc(c.cta)}</span>
          </div>
          <div class="reveal" id="rev_${i}">${esc(c.revealText)}</div>
        `;
        chunksEl.appendChild(div);
      });
      chunksEl.querySelectorAll(".chip").forEach(btn => {
        btn.addEventListener("click", () => {
          const i = btn.getAttribute("data-i");
          const rev = document.getElementById("rev_" + i);
          const open = rev.classList.contains("show");
          rev.classList.toggle("show", !open);
          btn.textContent = open ? SCENES[state.idx].chunks[i].cta : "Hide";
          btn.setAttribute("aria-expanded", String(!open));
        });
      });

      // Prompt
      const promptBox = $("#promptBox");
      if(scene.prompt){
        promptBox.style.display = "block";
        promptBox.innerHTML = `<strong>Connect‚Äëthe‚Äëdots:</strong> ${esc(scene.prompt)}`;
      }else{
        promptBox.style.display = "none";
      }

      // Terms
      const termsBox = $("#termsBox");
      const termRow = $("#termRow");
      const termDef = $("#termDef");
      termRow.innerHTML = "";
      termDef.classList.remove("show");
      termDef.textContent = "";

      if(scene.terms && scene.terms.length){
        termsBox.style.display = "block";
        scene.terms.forEach((t, i) => {
          const b = document.createElement("button");
          b.className = "termBtn";
          b.type = "button";
          b.textContent = t.t;
          b.setAttribute("aria-expanded", "false");
          b.addEventListener("click", () => {
            const expanded = b.getAttribute("aria-expanded") === "true";
            termRow.querySelectorAll(".termBtn").forEach(x => x.setAttribute("aria-expanded","false"));
            if(expanded){
              termDef.classList.remove("show");
              termDef.textContent = "";
              b.setAttribute("aria-expanded","false");
            }else{
              b.setAttribute("aria-expanded","true");
              termDef.innerHTML = `<strong>${esc(t.t)}:</strong> ${esc(t.d)}`;
              termDef.classList.add("show");
            }
          });
          termRow.appendChild(b);
        });
      }else{
        termsBox.style.display = "none";
      }

      // Sources
      const sLine = $("#sourcesLine");
      if(scene.sources && scene.sources.length){
        sLine.style.display = "block";
        sLine.innerHTML = `Sources: ${scene.sources.map(s => `<a href="${s.href}" target="_blank" rel="noopener noreferrer">${esc(s.label)}</a>`).join(" ‚Ä¢ ")}`;
      }else{
        sLine.style.display = "none";
      }

      // Learned marker
      const learned = !!state.learned[state.idx];
      $("#btnMark").textContent = learned ? "‚úì Learned (undo)" : "Mark learned";

      // Meta counts
      $("#deepCount").textContent = String(Object.keys(state.learned).filter(k => state.learned[k]).length);

      // Buttons
      $("#btnBack").disabled = state.idx === 0;
      $("#btnNext").disabled = state.idx === SCENES.length-1;
    }

    function go(delta){
      state.idx = clamp(state.idx + delta, 0, SCENES.length-1);
      save();
      render();
    }

    // Nav buttons
    $("#btnBack").addEventListener("click", () => go(-1));
    $("#btnNext").addEventListener("click", () => go(1));
    $("#btnRestart").addEventListener("click", () => {
      if(!confirm("Restart from Scene 1?")) return;
      state.idx = 0;
      save();
      render();
    });
    $("#btnMark").addEventListener("click", () => {
      state.learned[state.idx] = !state.learned[state.idx];
      save();
      render();
    });

    // Help sheet
    const sheetBack = $("#sheetBack");
    const openSheet = () => sheetBack.classList.add("show");
    const closeSheet = () => sheetBack.classList.remove("show");
    $("#btnHelp").addEventListener("click", openSheet);
    $("#btnCloseSheet").addEventListener("click", closeSheet);
    sheetBack.addEventListener("click", (e) => { if(e.target === sheetBack) closeSheet(); });

    // Keyboard arrows
    window.addEventListener("keydown", (e) => {
      if(sheetBack.classList.contains("show")) return;
      if(e.key === "ArrowRight") go(1);
      if(e.key === "ArrowLeft") go(-1);
    });

    // Swipe (mobile)
    let touchX = null, touchY = null;
    const threshold = 40;
    document.getElementById("card").addEventListener("touchstart", (e) => {
      const t = e.changedTouches[0];
      touchX = t.clientX;
      touchY = t.clientY;
    }, {passive:true});
    document.getElementById("card").addEventListener("touchend", (e) => {
      const t = e.changedTouches[0];
      const dx = t.clientX - touchX;
      const dy = t.clientY - touchY;
      touchX = null; touchY = null;
      if(Math.abs(dx) < threshold || Math.abs(dx) < Math.abs(dy)) return;
      if(dx < 0) go(1); else go(-1);
    }, {passive:true});

    // Init
    load();
    render();
  </script>

  <!--
    OPTIONAL IMAGE FILENAMES (max 6):
      images/machu-picchu.jpg
      images/andes.jpg
      images/amazon.jpg
      images/lima.jpg
      images/nazca.jpg
      images/ceviche.jpg
  -->
</body>
</html>
